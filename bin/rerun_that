#!/usr/bin/env bash
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : 202601061012-git
# @Author        : Jason Hempstead
# @Contact       : jason@casjaysdev.pro
# @License       : WTFPL
# @ReadME        : rerun_that --help
# @Copyright     : Copyright: (c) 2023 Jason Hempstead, CasjaysDev
# @Created       : Sunday, Apr 23, 2023 17:56 EDT
# @File          : rerun_that
# @Description   : Rerun commands with sudo or thefuck integration
# @Changelog     : Refactored for self-contained operation
# @TODO          : Better documentation
# @Other         :
# @Resource      :
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Script variables
PROG="rerun_that"
VERSION="202601061012-git"
USER="${SUDO_USER:-${USER}}"
HOME="${USER_HOME:-${HOME}}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Environment Detection
__get_os() {
  case "$(uname -s)" in
    Linux*) echo "linux" ;;
    Darwin*) echo "mac" ;;
    *BSD*) echo "bsd" ;;
    MINGW*|MSYS*|CYGWIN*) echo "windows" ;;
    *) echo "unknown" ;;
  esac
}

__is_remote() {
  [ -n "${SSH_CLIENT:-}" ] || [ -n "${SSH_TTY:-}" ] || [ -n "${SSH_CONNECTION:-}" ]
}

__has_display() {
  [ -n "${DISPLAY:-}" ] || [ -n "${WAYLAND_DISPLAY:-}" ]
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Core helper functions
__cmd_exists() { command -v "$1" >/dev/null 2>&1; }

__is_running() {
  local proc="$1"
  case "$(__get_os)" in
    mac) pgrep -x "$proc" >/dev/null 2>&1 ;;
    windows) tasklist 2>/dev/null | grep -qi "$proc" ;;
    *) pgrep -x "$proc" >/dev/null 2>&1 || pgrep -f "$proc" >/dev/null 2>&1 ;;
  esac
}

__printf_color() {
  local color="${2:-0}"
  printf "\033[0;%sm%s\033[0m\n" "$color" "$1"
}
__printf_red() { __printf_color "$1" "31"; }
__printf_green() { __printf_color "$1" "32"; }
__printf_yellow() { __printf_color "$1" "33"; }
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Smart notifications
__notifications() {
  local title="$1" msg="$2"

  # Remote/no display - just print to stderr
  if __is_remote || ! __has_display; then
    printf "[%s] %s\n" "$title" "$msg" >&2
    return 0
  fi

  # GUI notifications based on OS
  case "$(__get_os)" in
    mac)
      osascript -e "display notification \"$msg\" with title \"$title\"" 2>/dev/null && return 0
      ;;
    linux|bsd)
      if __cmd_exists notify-send; then
        notify-send "$title" "$msg" 2>/dev/null && return 0
      fi
      ;;
    windows)
      if __cmd_exists powershell.exe; then
        powershell.exe -Command "Add-Type -AssemblyName System.Windows.Forms; [System.Windows.Forms.MessageBox]::Show('$msg', '$title')" 2>/dev/null && return 0
      fi
      ;;
  esac

  # Fallback
  printf "[%s] %s\n" "$title" "$msg" >&2
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Sudo helper functions
__user_is_root() {
  [ "$(id -u)" -eq 0 ] || [ "$EUID" -eq 0 ] || [ "$(whoami)" = "root" ]
}

__can_i_sudo() {
  (sudo -vn && sudo -ln) 2>&1 | grep -vq 'may not' >/dev/null && return 0
  return 1
}

__sudorun() {
  if __user_is_root; then
    eval "$@"
  elif __can_i_sudo; then
    sudo -HE bash -c "$*"
  else
    __printf_red "Error: Unable to run with sudo privileges"
    return 1
  fi
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Thefuck integration
__thefuck() {
  local TF_PYTHONIOENCODING="$PYTHONIOENCODING"
  export TF_SHELL=bash
  export TF_ALIAS=fuck
  export TF_SHELL_ALIASES=$(alias 2>/dev/null)
  export TF_HISTORY=$(fc -ln -10 2>/dev/null)
  export PYTHONIOENCODING=utf-8
  local TF_CMD=$(thefuck THEFUCK_ARGUMENT_PLACEHOLDER "$@" 2>/dev/null) && eval "$TF_CMD"
  local exitCode=$?
  unset TF_HISTORY
  export PYTHONIOENCODING="$TF_PYTHONIOENCODING"
  [ -n "$TF_CMD" ] && history -s "$TF_CMD" 2>/dev/null
  return $exitCode
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Version and help
__version() { echo "$PROG $VERSION"; }

__help() {
  cat <<EOF
$PROG $VERSION - Rerun commands with sudo or thefuck integration

Usage: $PROG <command> [arguments...]

Commands:
  shit, balls       Rerun command with sudo (frustration mode)
  bork              Rerun command with sudo (dog mode)
  please            Rerun command with sudo (polite mode)
  fuck, fucking     Use thefuck to fix last command (if installed)

Options:
  -v, --version     Show version
  -h, --help        Show this help

Examples:
  $PROG shit apt update
  $PROG please systemctl restart nginx
  $PROG fuck

Note: The fuck/fucking commands require thefuck to be installed.
      If not installed, commands will be run with sudo instead.
EOF
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Main function
main() {
  local exitCode=0
  local COLUMNS="${COLUMNS:-130}"
  local MAX_WIDTH=$((COLUMNS - 30))

  # Parse options
  case "${1:-}" in
    -v|--version) __version; exit 0 ;;
    -h|--help) __help; exit 0 ;;
  esac

  # Check for command
  if [ $# -eq 0 ]; then
    __help >&2
    exit 1
  fi

  # Process commands
  case "$1" in
    bork)
      shift 1
      local set_args="${*:-}"
      __printf_red "${set_args:0:$MAX_WIDTH}"
      if [ $# -eq 0 ]; then
        __printf_red "Usage: $PROG bork !!"
        exit 1
      fi
      __sudorun "$@"
      exitCode=$?
      ;;
    please)
      shift 1
      local set_args="${*:-}"
      __printf_yellow "Well shit: ${set_args:0:$MAX_WIDTH}"
      if [ $# -eq 0 ]; then
        __printf_red "Usage: $PROG please !!"
        exit 1
      fi
      __sudorun "$@"
      exitCode=$?
      ;;
    shit|balls)
      shift 1
      local set_args="${*:-}"
      __printf_red "Well that didnt work: ${set_args:0:$MAX_WIDTH}"
      if [ $# -eq 0 ]; then
        __printf_red "Usage: $PROG $1 !!"
        exit 1
      fi
      __sudorun "$@"
      exitCode=$?
      ;;
    fuck|fucking)
      shift 1
      local set_args="${*:-}"
      if ! __cmd_exists thefuck; then
        __printf_red "No fucks given: ${set_args:0:$MAX_WIDTH}"
        if [ $# -eq 0 ]; then
          __printf_red "Usage: $PROG fuck !!"
          exit 1
        fi
        __sudorun "$@"
        exitCode=$?
      else
        __thefuck "$set_args"
        exitCode=$?
      fi
      ;;
    *)
      __printf_red "Unknown command: $1"
      __help >&2
      exit 1
      ;;
  esac

  return "$exitCode"
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Execute
main "$@"
exit $?
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# end
